<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Малчны бүртгэл</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-pink-100 min-h-screen flex items-center justify-center">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-md">
      <h1 class="text-3xl font-bold mb-6 text-center">Малчны бүртгэл</h1>

      <form id="herderForm" onsubmit="handleSubmit(event)">
        <div class="mb-4">
          <label class="block font-semibold">Он сар</label>
          <input type="date" id="date" class="mt-1 w-full p-2 border rounded" required />
        </div>

        <div class="mb-4">
          <label class="block font-semibold">Малчны нэр</label>
          <input type="text" id="name" class="mt-1 w-full p-2 border rounded" required />
        </div>

        <div class="mb-4">
          <label class="block font-semibold">Дансны дугаар</label>
          <input type="text" id="account" class="mt-1 w-full p-2 border rounded" required />
        </div>

        <div class="mb-4">
          <label class="block font-semibold">Утасны дугаар</label>
          <input type="text" id="phone" class="mt-1 w-full p-2 border rounded" required />
        </div>

        <div class="mb-4">
          <label class="block font-semibold">Адууны тоо</label>
          <input type="number" id="numHorses" min="1" class="mt-1 w-full p-2 border rounded" required />
          <button type="button" onclick="generateWeightInputs()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Жин оруулах талбарууд</button>
        </div>

        <div id="weightInputs" class="mb-4"></div>

        <div class="mb-4">
          <label class="block font-semibold">1 кг-ийн үнэ (100-аас дээш адуу)</label>
          <input type="number" id="pricePerKgAbove" min="1" class="mt-1 w-full p-2 border rounded" required />
        </div>

        <div class="mb-4 hidden" id="belowPriceSection">
          <label class="block font-semibold">1 кг-ийн үнэ (100-аас доош адуу)</label>
          <input type="number" id="pricePerKgBelow" min="1" class="mt-1 w-full p-2 border rounded" />
        </div>

        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded mt-4">
          Илгээх
        </button>
      </form>

      <div class="mt-6 p-4 bg-gray-100 rounded" id="result"></div>
    </div>

    <script>
      function generateWeightInputs() {
        const num = parseInt(document.getElementById('numHorses').value);
        const container = document.getElementById('weightInputs');
        container.innerHTML = '';
        for (let i = 1; i <= num; i++) {
          const label = document.createElement('label');
          label.className = 'block font-medium mt-2';
          label.innerText = `${i}-р адууны жин (кг):`;

          const input = document.createElement('input');
          input.type = 'number';
          input.className = 'horseWeight mt-1 w-full p-2 border rounded';
          input.min = '1';

          container.appendChild(label);
          container.appendChild(input);
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();

        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        const account = document.getElementById("account").value;
        const phone = document.getElementById("phone").value;
        const weights = [...document.querySelectorAll('.horseWeight')].map(input => parseFloat(input.value));
        const pricePerKgAbove = parseFloat(document.getElementById("pricePerKgAbove").value);
        const pricePerKgBelowInput = document.getElementById("pricePerKgBelow");
        const belowSection = document.getElementById("belowPriceSection");

        let totalAbove = 0, totalBelow = 0, hasBelow = false;

        weights.forEach(weight => {
          if (weight < 100) {
            totalBelow += weight;
            hasBelow = true;
          } else {
            totalAbove += weight;
          }
        });

        let pricePerKgBelow = 0;
        if (hasBelow) {
          belowSection.classList.remove('hidden');
          pricePerKgBelow = parseFloat(pricePerKgBelowInput.value);
          if (isNaN(pricePerKgBelow)) {
            alert("Доош кг-ийн үнийг оруулна уу!");
            return;
          }
        } else {
          belowSection.classList.add('hidden');
        }

        const totalKg = totalAbove + totalBelow;
        const totalPrice = totalAbove * pricePerKgAbove + totalBelow * pricePerKgBelow;

        const formData = {
          date,
          name,
          account,
          phone,
          totalAbove,
          totalBelow,
          totalKg,
          totalPrice
        };

        
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbym06iX9FXEKZVTbMzndBRPz-4msafl1R4JPLujvrvwbACEZqkTjpBUSy7aFzS_kT_WLA/exec";

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(formData)
          });

          const text = await response.text();
          document.getElementById("result").innerText = "Амжилттай илгээгдлээ!";
          document.getElementById("herderForm").reset();
          document.getElementById("weightInputs").innerHTML = '';
          belowSection.classList.add("hidden");
        } catch (err) {
          document.getElementById("result").innerText = "Алдаа гарлаа: " + err.message;
        }
      }
    </script>
  </body>
</html>
